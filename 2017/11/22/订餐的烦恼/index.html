<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>订餐的烦恼 | lqs469</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="美餐。一种服务于阿里部分BU的神奇机构，主要任务是每天定时定点的饲养加班的程序猿，如果你错过了申请投食的时间，那么抱歉，对于没有时间出去吃一顿的加班汪来说，你就要饿肚子了…  又过了订餐时间?”啪啪啪…“，在一阵急促的键盘敲击声中，时间已经到了4点60分，忙碌的硕硕已经伏案在显示器前超过3个小时了，办公室又热又闷，可以明显觉察到空气是不流通的，电脑的风扇散热提醒他应该调整一下姿势，于是他决定起来">
<meta property="og:type" content="article">
<meta property="og:title" content="订餐的烦恼">
<meta property="og:url" content="http://yoursite.com/2017/11/22/订餐的烦恼/index.html">
<meta property="og:site_name" content="lqs469">
<meta property="og:description" content="美餐。一种服务于阿里部分BU的神奇机构，主要任务是每天定时定点的饲养加班的程序猿，如果你错过了申请投食的时间，那么抱歉，对于没有时间出去吃一顿的加班汪来说，你就要饿肚子了…  又过了订餐时间?”啪啪啪…“，在一阵急促的键盘敲击声中，时间已经到了4点60分，忙碌的硕硕已经伏案在显示器前超过3个小时了，办公室又热又闷，可以明显觉察到空气是不流通的，电脑的风扇散热提醒他应该调整一下姿势，于是他决定起来">
<meta property="og:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/4DC01FB4-6A94-4A15-A498-48722B222DE8.png">
<meta property="og:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/938F90EE-15CB-4BDE-9C9D-9D988E885812.png">
<meta property="og:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/15E03D39-2C29-4009-AFDF-818D92E74790.png">
<meta property="og:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/2FCBE32A-7675-4D4D-A7D7-9689D84F57FA.png">
<meta property="og:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/C97B9855-B098-4456-BCF9-D2920D87AB7B.png">
<meta property="og:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/9C521295-8480-450C-85EC-9DD68582E95A.png">
<meta property="og:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/DDE43401-A029-4CFE-A246-9ECFD3FA9EB1.png">
<meta property="og:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/749E6AD5-7507-4136-B9C0-4997234B6C03.png">
<meta property="og:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/AFAC8BC9-008E-4097-8D44-08942DFDE6C8.png">
<meta property="og:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/53EC41A0-2753-4FDA-8B7B-C383DA2400AF.png">
<meta property="og:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/51E15540-5B67-4332-9169-BB79D4F49ED5.png">
<meta property="og:updated_time" content="2017-11-22T08:48:07.049Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="订餐的烦恼">
<meta name="twitter:description" content="美餐。一种服务于阿里部分BU的神奇机构，主要任务是每天定时定点的饲养加班的程序猿，如果你错过了申请投食的时间，那么抱歉，对于没有时间出去吃一顿的加班汪来说，你就要饿肚子了…  又过了订餐时间?”啪啪啪…“，在一阵急促的键盘敲击声中，时间已经到了4点60分，忙碌的硕硕已经伏案在显示器前超过3个小时了，办公室又热又闷，可以明显觉察到空气是不流通的，电脑的风扇散热提醒他应该调整一下姿势，于是他决定起来">
<meta name="twitter:image" content="http://yoursite.com/2017/11/22/订餐的烦恼/4DC01FB4-6A94-4A15-A498-48722B222DE8.png">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/typing.css">
  
</head>

  
    
      <body>
    
  
      <div id="container" class="container">
        <article id="post-订餐的烦恼" class="article article-type-post" itemscope itemprop="blogPost">
  <header id="header" class="header">
  <nav id="main-nav" class="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
</header>

  <hr/>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      订餐的烦恼
    </h1>
  

      </header>
    
    <div class="article-entry typo" itemprop="articleBody">
      
        <blockquote>
<p>美餐。一种服务于阿里部分BU的神奇机构，主要任务是每天定时定点的饲养加班的程序猿，如果你错过了申请投食的时间，那么抱歉，对于没有时间出去吃一顿的加班汪来说，你就要饿肚子了…</p>
</blockquote>
<h3 id="又过了订餐时间"><a href="#又过了订餐时间" class="headerlink" title="又过了订餐时间?"></a>又过了订餐时间?</h3><p>”啪啪啪…“，在一阵急促的键盘敲击声中，时间已经到了4点60分，忙碌的硕硕已经伏案在显示器前超过3个小时了，办公室又热又闷，可以明显觉察到空气是不流通的，电脑的风扇散热提醒他应该调整一下姿势，于是他决定起来走一走，站起身，突然他觉得身体有点异样，他饿了…</p>
<p>一看表，已经是4点61分。完蛋，又完美地错过了订饭的时间… 看来今天的晚餐注定又要凑合挨饿了。哎，要是有一个提醒我及时订饭的服务就好了，闹钟？不不，那么low的东西怎么能彰显我的geek精神呢。对，做一个钉钉机器人吧，不不，只做一个机器人怎么够，既然要做就做个全套的，再研究一下美餐的订餐数据，找到最好吃的那个套餐，恩，听起来不错，就这样，动手~</p>
<h3 id="抓抓数据"><a href="#抓抓数据" class="headerlink" title="抓抓数据"></a>抓抓数据</h3><p>美餐的数据是个很蛋疼的问题，用户使用自己的独立账号登录App来完成所有操作，我没办法去网上爬数据下来，只好抓一下数据接口，意外的发现了原来美餐还提供了一个<a href="https://meican.com/preorder/static/group" target="_blank" rel="external">web的订餐渠道</a>，很好，这样就可以直接拿官方准备的数据了。研究了一会，终于搞清楚了每个接口的对应的数据内容。<br>从主页登录之后，会跳转到每个用户可选的几个地点，这个是也是订餐操作的第一步：</p>
<p>得到的数据格式是这样（去掉了一些无关的数据）：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// API: https://meican.com/preorder/data/group?x=&#123; userId &#125;</div><div class="line">&#123;</div><div class="line">	groups: [</div><div class="line">		&#123; title: "首开", … &#125;,</div><div class="line"> 		&#123; title: "方恒国际", … &#125;,</div><div class="line"> 		&#123; title: "昌平", … &#125;</div><div class="line">	]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后选择订餐的地点之后会跳转到可选的所有时间地点的组合，接口数据如下（去掉了一些无关数据）：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">// API: https://meican.com/preorder/api/v2.1/calendarItems/list？beginDate=2017-11-1&amp;endDate=2017-11-8&amp;withOrderDetail=false)</div><div class="line">// 默认会得到一周的可订餐信息，所以会有开始时间和结束时间</div><div class="line">&#123;</div><div class="line">	dateList: [</div><div class="line">		&#123;</div><div class="line">			calendarItemList: [</div><div class="line">				&#123;</div><div class="line">					openingTime: &#123;</div><div class="line">						closeTime: "16:30",</div><div class="line">						...</div><div class="line">					&#125;,</div><div class="line">					title: "高德地图（首开外卖）晚餐1"</div><div class="line">					status: "NOT_YET",</div><div class="line">					userTab: &#123;</div><div class="line">						corp: &#123;</div><div class="line">							uniqueId: "ff4df9a0-9851-4205-adae-b154cc05d811",</div><div class="line">							...</div><div class="line">						&#125;</div><div class="line">					&#125;,</div><div class="line">					...</div><div class="line">				&#125;,</div><div class="line">				...</div><div class="line">			]</div><div class="line">		&#125;,</div><div class="line">		...</div><div class="line">	],</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从接口数据可以知道，订餐结束的时间，地点以及当前是否可订的状态（还有一个uniqueId，这个会在下面的接口使用到）。</p>
<p>继续进入我们想要的时间地点组合，例如上面的 “18：30  高德地图（首开外卖）晚餐1”，就会得到所有可选店铺的列表：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// API: https://meican.com/preorder/api/v2.1/restaurants/list?&amp;tabUniqueId=ff4df9a0-9851-4205-adae-b154cc05d811&amp;targetTime=2017-11-01+16:30</div><div class="line">// 可以看到，使用了上一步的 uniqueId 作为query参数，</div><div class="line">&#123;</div><div class="line">	restaurantList: [</div><div class="line">		&#123;</div><div class="line">			availableDishCount: 80,</div><div class="line">			dishLimit: 100,</div><div class="line">			latitude: 39.991464,</div><div class="line">			longitude: 116.396763,</div><div class="line">			name: "宅食送(UBP店)",</div><div class="line">			...</div><div class="line">		&#125;,</div><div class="line">		...</div><div class="line">	]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回数据里不光有点名和地理位置，居然还有可以总订餐量（dishLimit）和当前可订量（availableDishCount），这就十分美好了，这个数据就可以用来做我们之前计划的订餐情况分析。</p>
<h3 id="发发推送"><a href="#发发推送" class="headerlink" title="发发推送"></a>发发推送</h3><p>我们已经得到了数据，那么就需要完成计划的第一步，做一个钉钉机器人来告诉我“该订餐了”。打开钉钉的聊天窗口，找到机器人：<br><img src="4DC01FB4-6A94-4A15-A498-48722B222DE8.png" alt=""></p>
<p><img src="938F90EE-15CB-4BDE-9C9D-9D988E885812.png" alt=""></p>
<p>直接添加机器人，然后选择自定义机器人</p>
<p><img src="15E03D39-2C29-4009-AFDF-818D92E74790.png" alt=""></p>
<p>然后下一步，知道最后会给你一个webhook，那个就是用来发送推送的hook：</p>
<p><img src="2FCBE32A-7675-4D4D-A7D7-9689D84F57FA.png" alt=""></p>
<p>然后只需要在代码里合适的时机post这个webhook 就可以触发机器人在当前聊天群里的动作了：</p>
<p><img src="C97B9855-B098-4456-BCF9-D2920D87AB7B.png" alt=""></p>
<p>相关的推送内容格式和方法参考这里的官方文档<a href="https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.karFPe&amp;treeId=257&amp;articleId=105735&amp;docType=1" target="_blank" rel="external">钉钉开放平台 - 文档中心</a>，推送格式有个很好的地方就是支持markdown，这样的话就可以很方便的组织内容。</p>
<p>我选用NodeJS来做推送服务，首先是抓取数据，做过滤，格式转换，然后当 ”status“值为“AVAILABLE”且当前时间比结束时间早3个小时的时候通知我，代码会隔一分钟访问一次接口，这样就不会在同一分钟内通知我两遍，这样推送的代码就完成了（代码我会放在文章结束）。另外我还在推送内容里加上一张来自<code>lorempixel.com</code>的随机美图来促进我的食欲。</p>
<p><img src="9C521295-8480-450C-85EC-9DD68582E95A.png" alt=""></p>
<p>最后把工程放入Docker里，每天在后台跑着，通过机器人定时推送给我消息，就再也不用担心错过订餐啦~</p>
<h3 id="看看数据"><a href="#看看数据" class="headerlink" title="看看数据"></a>看看数据</h3><p>吾日三省吾身，早中晚餐该吃啥。我已经能够得到我想要的时间地点的订餐数据了，那么我干嘛不把所有时间店铺的数据抓下来看看呢。</p>
<p>但是真实情况是总共的数据并不多，我有尝试过抓取几个月前半年以前的数据，但是发现美餐好像定期的删除之前的数据，所有数据大概只会保存一个月左右的。<br>店铺数据：<br><img src="DDE43401-A029-4CFE-A246-9ECFD3FA9EB1.png" alt=""></p>
<p>店铺地理位置图：<br><img src="749E6AD5-7507-4136-B9C0-4997234B6C03.png" alt=""><br>可以看到店铺大致都是分布在望京周围，毕竟太远的也不会承接这么大规模的送餐。<br>有一个比较好玩的是有一个很奇葩的店铺开在黄海上，恩… 这一定是个脏数据…（这家店是JYJ…）<br><img src="AFAC8BC9-008E-4097-8D44-08942DFDE6C8.png" alt=""></p>
<p>然后我先统计了每日的订餐率，取了60天的数据，但是中间有一些天是缺少的，不知道美餐的数据统计部门是怎么做的… 可以看到起数据还是有明显起伏的。然后我检查了他们对应的时间，其中10-29日达到了100%订餐，也就是所有店铺的餐全部订光了，检查了一下数据，发现那一天只有一家店铺在提供晚饭，所以被订光也是可以理解的了。<br><img src="53EC41A0-2753-4FDA-8B7B-C383DA2400AF.png" alt=""></p>
<p>之后做了一个餐厅的平均订餐率统计，发现订餐率最高的是金百万，有87.7%的订餐率，成为最受大家欢迎的店铺，其次是丽华快餐，订餐率达到87.1%，而最不受欢迎的店铺果然是兰州牛肉拉面，订餐率只有12.3%，这也挺符合大家平时的评价…<br><img src="51E15540-5B67-4332-9169-BB79D4F49ED5.png" alt=""></p>
<p>通过这样就找到公司附近这段时间最优质的外卖，对于我这种选择恐惧症来说，大大缩短了选择的时间，还可以定期的看一看最近的店铺情况，会第一时间发现有新的店铺加入，这样就在订餐的时候，掌握更多更好的信息。</p>
<p>最后附上<a href="https://github.com/lqs469/meicanRobot" target="_blank" rel="external">代码</a>，欢迎大家和我交流。</p>

      
    </div>
    <footer class="article-footer">
      <ul class="article-meta">
        <li>
          <span class="label">Published Date:</span>
          <a href="/2017/11/22/订餐的烦恼/" class="article-date">
  <time datetime="2017-11-22T08:34:10.000Z" itemprop="datePublished">2017-11-22</time>
</a>

        </li>
        
          <li>
            <span class="label">Categoría:</span>
            
  <div class="article-category">
    <a class="article-category-link" href="/categories/弱鸡之路/">弱鸡之路</a>
  </div>


          </li>
        
        
        <hr/>
      </ul>
    </footer>
  </div>
  
    
<nav id="article-nav" class="article-nav">
  
    <span id="article-nav-newer" class="article-nav-link-wrap newer"></span>
  
  
    <a href="/2017/10/25/Reactv16-0新特性探究/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Viejo</strong>
      <div class="article-nav-title">React 16.0新特性探究</div>
    </a>
  
</nav>


  
</article>






      </div>
      
    <footer id="footer" class="post-footer footer">
      
      <hr/>
      <div id="footerContent" class="footer-content">
        

      </div>
    </footer>

      



<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/typing.js"></script>
<!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->






<script type="text/javascript">
  console.log('anlysis')
  var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
  document.write(unescape("%3Cspan id='cnzz_stat_icon_1264607064'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1264607064' type='text/javascript'%3E%3C/script%3E"));
</script>

    </div>
  </body>
</html>
